function tool_tip_label(tooltipItem,data){if(data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index].label){return data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index].label}else{return data.datasets[tooltipItem.datasetIndex].label+": "+data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index].y}}function tool_tip_title(){return""}(function(reporting,$,nonces){const{sprintf,__,_x,_n}=wp.i18n;const{emails:EmailsStore,campaigns:CampaignsStore}=Groundhogg.stores;const{ItemPicker,Table,Tr,Td,Th,THead,TBody,Fragment,Button,Div}=MakeEl;const{loadingModal}=Groundhogg.element;$.extend(reporting,{data:{},calendar:null,charts:{},init:function(){this.initCalendar();this.initFunnels();this.initCountry();this.initBroadcast();this.initCampaignFilter()},async initCampaignFilter(){let el=document.getElementById("report-campaign-filter");if(!el){return}let campaignId=this.other.campaign;if(campaignId&&!CampaignsStore.has(campaignId)){await CampaignsStore.fetchItem(campaignId)}el.append(ItemPicker({id:"report-campaign",noneSelected:__("Filter by campaign...","groundhogg"),multiple:false,selected:campaignId?(({ID,data})=>({id:ID,text:data.name}))(CampaignsStore.get(campaignId)):[],fetchOptions:async search=>{let campaigns=await CampaignsStore.fetchItems({search:search,limit:20});return campaigns.map(({ID,data})=>({id:ID,text:data.name}))},onChange:item=>{if(!item){this.other.campaign=null}else{this.other.campaign=item.id}this.refresh(this.calendar)}}))},initCalendar:function(){var self=this;this.calendar=new Calendar({element:$("#groundhogg-datepicker"),presets:[{label:"Last 30 days",start:moment().subtract(29,"days"),end:moment()},{label:"This month",start:moment().startOf("month"),end:moment().endOf("month")},{label:"Last month",start:moment().subtract(1,"month").startOf("month"),end:moment().subtract(1,"month").endOf("month")},{label:"Last 7 days",start:moment().subtract(6,"days"),end:moment()},{label:"Last 3 months",start:moment().subtract(3,"month").startOf("month"),end:moment().subtract(1,"month").endOf("month")},{label:"This year",start:moment().startOf("year"),end:moment().endOf("year")}],format:{preset:GroundhoggReporting.date_format},earliest_date:"January 1, 2017",latest_date:moment(),start_date:self.dates.start_date,end_date:self.dates.end_date,callback:function(){self.refresh(this)}});this.calendar.calendarSaveDates()},initFunnels:function(){var self=this;$("#funnel-id").change(function(){self.refresh(self.calendar)})},initBroadcast:function(){var self=this;$("#broadcast-id").change(function(){self.refresh(self.calendar)})},initCountry:function(){var self=this;$("#country").change(function(){self.refresh(self.calendar)})},refresh:function(calendar){var self=this;let{close}=loadingModal();var start=calendar.start_date.format("YYYY-MM-DD"),end=calendar.end_date.format("YYYY-MM-DD");$.ajax({type:"post",url:ajaxurl,dataType:"json",data:{action:"groundhogg_refresh_dashboard_reports",reports:self.reports,start:start,end:end,data:{...reporting.other}},success:function(json){self.data=json.data.reports;self.renderReports();close();$(".wrap").removeClass("blurred");window.dispatchEvent(new Event("resize"))},failure:function(response){alert("Unable to retrieve data...")}})},get_other_data:function(){var self=this;var data={};$(".post-data").each(function(i){var $this=$(this);var name=$this.attr("name");if(name==="funnel"){name="funnel_id"}data[name]=$this.val()});return data},renderReports:function(){for(var i=0;i<this.reports.length;i++){var report_id=this.reports[i];var report_data=this.data[report_id];this.renderReport(report_id,report_data)}},renderReport:function(report_id,report_data){var $report=$("#"+report_id);if(!$report.length){return}var type=report_data.type;switch(type){case"quick_stat":this.renderQuickStatReport($report,report_data);break;case"chart":this.renderChartReport($report,report_data.chart,report_id);break;case"table":this.renderTable($report,report_data,report_id);break}},renderQuickStatReport:function($report,report_data){$report.find(".groundhogg-quick-stat-number").html(report_data.number);$report.find(".groundhogg-quick-stat-previous").removeClass("green red").addClass(report_data.compare.arrow.color);$report.find(".groundhogg-quick-stat-compare").html(report_data.compare.text);$report.find(".groundhogg-quick-stat-arrow").removeClass("up down").addClass(report_data.compare.arrow.direction);$report.find(".groundhogg-quick-stat-prev-percent").html(report_data.compare.percent)},renderChartReport:function($report,report_data,report_id){if(report_data.data.labels&&report_data.data.labels.length===0){$report.closest(".gh-donut-chart-wrap").html(report_data.no_data)}if(typeof report_data.options.tooltips.callbacks!=="undefined"){var funcName=report_data.options.tooltips.callbacks.label;report_data.options.tooltips.callbacks.label=window[funcName]}if(typeof report_data.options.tooltips.callbacks!=="undefined"){var funcName=report_data.options.tooltips.callbacks.title;report_data.options.tooltips.callbacks.title=window[funcName]}if(this.charts[report_id]){this.charts[report_id].destroy()}var ctx=$report[0].getContext("2d");var chart=new Chart(ctx,report_data);this.charts[report_id]=chart;var draw_line=Chart.controllers.line.prototype.draw;Chart.helpers.extend(Chart.controllers.line.prototype,{draw:function(){draw_line.apply(this,arguments);if(this.chart.tooltip._active&&this.chart.tooltip._active.length){var ap=this.chart.tooltip._active[0];var ctx=this.chart.ctx;var x=ap.tooltipPosition().x;var topy=this.chart.scales["y-axis-0"].top;var bottomy=this.chart.scales["y-axis-0"].bottom;ctx.save();ctx.beginPath();ctx.moveTo(x,topy);ctx.lineTo(x,bottomy);ctx.lineWidth=1;ctx.strokeStyle="#727272";ctx.setLineDash([10,10]);ctx.stroke();ctx.restore()}}});Chart.plugins.register({afterDraw:function(chart){if(chart.data.datasets.length===0){var ctx=chart.chart.ctx;var width=chart.chart.width;var height=chart.chart.height;chart.clear();ctx.save();ctx.textAlign="center";ctx.textBaseline="middle";ctx.font="16px normal 'Helvetica Nueue'";ctx.fillText("No data to display",width/2,height/2);ctx.restore()}}})},renderTable:function($report,report_data,id){let{label,data,no_data:no_data=""}=report_data;if(!Array.isArray(label)){label=Object.values(label)}if(!data.length){$report.html(no_data);return}const ReportTable=()=>{const State=Groundhogg.createState({per_page:10,page:0});const morph=()=>morphdom($report[0],Div({},Render()),{childrenOnly:true});const getData=()=>data.slice(State.per_page*State.page,State.per_page*State.page+State.per_page);const TableBody=()=>TBody({},getData().map(row=>Tr({},Object.keys(row).map(k=>{return Td({dataColname:k},`${row[k]}`)}))));const replaceBody=()=>{$report[0].querySelector("tbody").replaceWith(TableBody())};const Render=()=>Fragment([Table({className:"groundhogg-report-table"},[THead({},Tr({},label.map(label=>Th({},label)))),TableBody()]),Div({style:{padding:"10px"},className:"display-flex gap-10 flex-end"},[State.page>0?Button({id:`${id}-prev`,className:"gh-button secondary",onClick:e=>{State.set({page:State.page-1});morph()}},"Prev"):null,(State.page+1)*State.per_page<data.length?Button({id:`${id}-next`,className:"gh-button secondary",onClick:e=>{State.set({page:State.page+1});morph()}},"Next"):null])]);return Render()};$report.html(ReportTable())}});$(function(){reporting.init()})})(GroundhoggReporting,jQuery,groundhogg_nonces);